<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Đặt lại mật khẩu</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">
                    <h2>Đặt lại mật khẩu</h2>
                </div>
                <div class="card-body">
                    <form th:object="${user}" id="reset-password-form" th:action="@{/reset-password}" method="post">
                        <!-- CSRF Token -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <!-- Hidden field for email -->
                        <input type="hidden" name="email" th:value="${email}">

                        <!-- Password field -->
                        <div class="mb-3">
                            <label for="password" class="form-label">Mật khẩu mới</label>
                            <input name="password" type="password" th:field="*{password}" class="form-control" id="password" placeholder="Nhập mật khẩu mới" required>
                            <div style="color: red;" id="passwordError"></div>
                        </div>

                        <!-- Confirm Password field -->
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Nhập lại mật khẩu</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Nhập lại mật khẩu mới" required>
                            <div style="color: red;" id="confirmPasswordError"></div>
                        </div>

                        <!-- Submit button -->
                        <button type="submit" id="submitButton" class="btn btn-primary w-100">Cập nhật mật khẩu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Custom JavaScript -->
<script>
    $(document).ready(function () {
        let isPasswordValid = false;
        let isConfirmPasswordValid = false;

        function validatePassword() {
            const password = $('#password').val();
            const upperCaseRegex = /[A-Z]/;  // Kiểm tra ký tự viết hoa
            let errorMessage = '';

            if (password.length < 8) {
                errorMessage = 'Mật khẩu phải có ít nhất 8 ký tự.';
            } else if (!upperCaseRegex.test(password)) {
                errorMessage = 'Mật khẩu phải có ít nhất 1 ký tự viết hoa.';
            }

            if (errorMessage) {
                $('#passwordError').text(errorMessage);
                isPasswordValid = false;
            } else {
                $('#passwordError').text('');
                isPasswordValid = true;
            }

            // Kiểm tra lại xác nhận mật khẩu
            validateConfirmPassword();

            toggleSubmitButton();
        }

        function validateConfirmPassword() {
            const password = $('#password').val();
            const confirmPassword = $('#confirmPassword').val();
            let errorMessage = '';

            if (confirmPassword !== password) {
                errorMessage = 'Mật khẩu nhập lại không khớp.';
                isConfirmPasswordValid = false;
            } else {
                isConfirmPasswordValid = isPasswordValid; // Chỉ khi mật khẩu hợp lệ
            }

            $('#confirmPasswordError').text(errorMessage);
            toggleSubmitButton();
        }

        function toggleSubmitButton() {
            if (isPasswordValid && isConfirmPasswordValid) {
                $('#submitButton').prop('disabled', false);
            } else {
                $('#submitButton').prop('disabled', true);
            }
        }

        // Sự kiện onblur cho trường mật khẩu
        $('#password').on('blur', function () {
            validatePassword();
        });

        // Sự kiện onblur cho trường xác nhận mật khẩu
        $('#confirmPassword').on('blur', function () {
            validateConfirmPassword();
        });

        // Ngăn submit form nếu có lỗi (phòng trường hợp người dùng bypass)
        $('#reset-password-form').on('submit', function (e) {
            if (!isPasswordValid || !isConfirmPasswordValid) {
                e.preventDefault();
            }
        });
    });
</script>
</body>
</html>
